<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUGRID Protocol Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #111827;
            color: #F9FAFB;
        }
        .gradient-text {
            background: linear-gradient(90deg, #4F46E5, #EC4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .phone-screen {
            background-color: #000;
            border: 8px solid #4B5563;
            border-radius: 40px;
            width: 300px;
            height: 600px;
            padding: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .witness-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid #4B5563;
            background-color: #1F2937;
        }
        .node-idle { border-color: #4B5563; background-color: #1F2937; }
        .node-receiving { border-color: #4F46E5; background-color: #3730A3; transform: scale(1.1); }
        .node-validating { border-color: #F59E0B; background-color: #B45309; animation: pulse 1s infinite; }
        .node-signed { border-color: #10B981; background-color: #047857; }
        .node-failed { border-color: #EF4444; background-color: #991B1B; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .log-panel {
            background-color: #1F2937;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
        }
        .action-button {
            background: linear-gradient(90deg, #4F46E5, #EC4899);
            color: white;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 9999px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
        }
        .action-button:disabled {
            background: #4B5563;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body>

<div class="container mx-auto p-4">
    <header class="text-center my-8">
        <h1 class="text-4xl font-black tracking-tight gradient-text">TRUGRID プロトコル・シミュレーター</h1>
        <p class="mt-2 text-gray-400">オフライン分散型行動証明プロセスの可視化</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Smartphone Column -->
        <div class="flex justify-center items-center flex-col">
            <h2 class="text-2xl font-bold mb-4">ユーザー端末 (第1の端末)</h2>
            <div class="phone-screen flex flex-col justify-between">
                <div>
                    <h3 class="text-center font-bold text-lg text-gray-300">TRUGRID App</h3>
                    <div id="certificate-display" class="mt-4 p-2 bg-gray-900 rounded-md text-xs text-green-400 overflow-auto h-64 whitespace-pre-wrap break-words">
                        // 証明書(C1)はここに表示されます
                    </div>
                </div>
                <button id="tap-button" class="action-button w-full">Tap to Prove Visit</button>
            </div>
        </div>

        <!-- Witness Nodes & Log Column -->
        <div class="lg:col-span-2">
            <div>
                <h2 class="text-2xl font-bold mb-4 text-center">Witnessノード群 & 公開ログ</h2>
                <div class="bg-gray-800 p-6 rounded-lg shadow-2xl">
                    <div class="flex justify-center flex-wrap gap-4 mb-6" id="witness-nodes-container">
                        <!-- Witness nodes will be generated here by JS -->
                    </div>
                    <div class="flex justify-center items-center mb-6">
                         <label for="threshold-slider" class="mr-4">閾値 (m/n): <span id="threshold-label">3/5</span></label>
                         <input id="threshold-slider" type="range" min="1" max="5" value="3" class="w-48">
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-bold mb-2">シミュレーション・ログ (特許図解)</h3>
                            <div id="simulation-log" class="log-panel"></div>
                        </div>
                        <div>
                             <h3 class="font-bold mb-2">公開ログサーバー (40)</h3>
                             <div id="public-log" class="log-panel"></div>
                        </div>
                     </div>
                </div>
                 <div class="text-center mt-6">
                    <button id="reset-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full transition">リセット</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const tapButton = document.getElementById('tap-button');
    const resetButton = document.getElementById('reset-button');
    const simulationLog = document.getElementById('simulation-log');
    const publicLog = document.getElementById('public-log');
    const certificateDisplay = document.getElementById('certificate-display');
    const nodesContainer = document.getElementById('witness-nodes-container');
    const thresholdSlider = document.getElementById('threshold-slider');
    const thresholdLabel = document.getElementById('threshold-label');

    const TOTAL_NODES = 5;
    let requiredSignatures = 3;
    let nodes = [];

    // --- UTILITY FUNCTIONS ---
    function log(panel, message) {
        const timestamp = new Date().toLocaleTimeString();
        panel.innerHTML += `[${timestamp}] ${message}\n`;
        panel.scrollTop = panel.scrollHeight;
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function generateHash(length = 10) {
        return [...Array(length)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
    }

    // --- UI & STATE MANAGEMENT ---
    function initializeNodes() {
        nodesContainer.innerHTML = '';
        nodes = [];
        for (let i = 0; i < TOTAL_NODES; i++) {
            const nodeEl = document.createElement('div');
            nodeEl.classList.add('witness-node', 'node-idle');
            nodeEl.id = `node-${i}`;
            nodeEl.innerHTML = `Witness<br>#${i+1}`;
            nodesContainer.appendChild(nodeEl);
            nodes.push({ id: i, el: nodeEl, status: 'idle' });
        }
    }

    function setNodeStatus(nodeId, status) {
        const node = nodes[nodeId];
        node.status = status;
        node.el.className = 'witness-node'; // Reset classes
        node.el.classList.add(`node-${status}`);
    }

    function updateThresholdLabel() {
        requiredSignatures = parseInt(thresholdSlider.value);
        thresholdLabel.textContent = `${requiredSignatures}/${TOTAL_NODES}`;
    }

    // --- SIMULATION LOGIC ---
    async function runSimulation() {
        tapButton.disabled = true;
        certificateDisplay.innerHTML = '// 証明書(C1)を生成中...';
        
        // 1. 行動データ送信 (【図1】 S10)
        log(simulationLog, '【S10】行動データ(nonce付)をWitnessノード群へ送信...');
        nodes.forEach(node => setNodeStatus(node.id, 'receiving'));
        await delay(1000);

        // 2. 相互検証及び閾値連署 (【図1】 S20)
        log(simulationLog, '【S20】各ノードが相互検証を開始...');
        nodes.forEach(node => setNodeStatus(node.id, 'validating'));
        await delay(1500);

        let signedCount = 0;
        const signatoryIds = [];
        nodes.forEach(node => {
            // Simulate some nodes succeeding and some failing
            const success = Math.random() > 0.2; // 80% success rate
            if (success) {
                setNodeStatus(node.id, 'signed');
                signedCount++;
                signatoryIds.push(node.id + 1);
            } else {
                setNodeStatus(node.id, 'failed');
            }
        });
        
        log(simulationLog, `検証完了。 ${signedCount}/${TOTAL_NODES} ノードが署名可能。`);

        // 3. 証明書生成 or 失敗 (【図3】)
        if (signedCount >= requiredSignatures) {
            log(simulationLog, `閾値(${requiredSignatures})を達成。連署を合成し証明書を生成します。`);
            await delay(1000);

            const certificate = {
                certificateId: `C1-${generateHash(8)}`,
                timestamp: new Date().toISOString(),
                action: "Store Visit: SHIBUYA 109",
                signatoryNodes: signatoryIds,
                requiredThreshold: `${requiredSignatures}/${TOTAL_NODES}`,
                finalHash: `0x${generateHash(64)}`
            };

            // 【S40】証明書返送
            log(simulationLog, '【S40】証明書(C1)をユーザー端末へ返送しました。');
            certificateDisplay.textContent = JSON.stringify(certificate, null, 2);

            // 【S30】ハッシュ値送信
            log(simulationLog, '【S30】証明書のハッシュを公開ログサーバーへ送信...');
            await delay(500);
            log(publicLog, `[RECEIVE] HASH: ${certificate.finalHash}`);
            log(publicLog, `[TIMESTAMP] HASHにタイムスタンプを付与し記録しました。`);

        } else {
            log(simulationLog, `閾値(${requiredSignatures})未達。証明に失敗しました。`);
            log(simulationLog, '【例外処理】行動データを無効化します。');
            certificateDisplay.textContent = '// 証明に失敗しました。\n// 署名数が閾値に達しませんでした。';
        }

        tapButton.disabled = false;
    }

    function resetSimulation() {
        tapButton.disabled = false;
        simulationLog.innerHTML = '';
        publicLog.innerHTML = '';
        certificateDisplay.innerHTML = '// 証明書(C1)はここに表示されます';
        initializeNodes();
        log(simulationLog, 'シミュレーターをリセットしました。');
    }

    // --- EVENT LISTENERS ---
    tapButton.addEventListener('click', runSimulation);
    resetButton.addEventListener('click', resetSimulation);
    thresholdSlider.addEventListener('input', updateThresholdLabel);

    // --- INITIALIZATION ---
    window.onload = () => {
        initializeNodes();
        updateThresholdLabel();
        log(simulationLog, 'TRUGRIDプロトコル・シミュレーターへようこそ。');
        log(simulationLog, '"Tap to Prove Visit" をクリックして開始してください。');
    };
</script>
</body>
</html>
